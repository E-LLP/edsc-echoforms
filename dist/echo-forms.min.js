/*
 *  echo-forms.js - v1.0.0
 */
(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};!function(b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;return null==(s=String.prototype).trim&&(s.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")}),p=function(){return!(!object||"[object Function]"!==getClass.call(object))},q=function(a,c){return b(a).find(c).filter(function(){return!b(this).parentsUntil(a,c).length})},n=[j,i,m,k],r="echoform",o={controls:[]},h=function(){function a(a){console.log(a),this.document=xmlParse(a),console.log(this.document),this.root=this.document.firstChild,this.root.prefixElements(),b(e).trigger("echoforms:instanceChange",this)}return a.prototype.find=function(a,b){var c;return c=new ExprContext(null!=a?a:this.root),xpathParse(b).evaluate(c).value},a.prototype.update=function(a,c,d,f){var g,h,i,j;for(null!=d&&(d=this.namespace(a,d)),h=c?this.find(a,c):[a],i=0,j=h.length;j>i;i++)g=h[i],g.setValues(f,d);return b(e).trigger("echoforms:instanceChange",this)},a.prototype.namespace=function(a,b){var c;return c=XNode.create(DOM_ELEMENT_NODE,b,null,null),null==c.getNamespacePrefix()&&c.setNamespacePrefix(a.getNamespacePrefix()),c.nodeName},a.prototype.prune=function(a,b){return XNode.removeAll(this.find(a,b))},a.prototype.serialize=function(){return xmlText(this.document)},a}(),g=function(){function b(b){this.el=b,this.changed=a(this.changed,this),this.inputs().bind("click change",onChange)}return b.prototype.isChanged=function(a){return this.getValue().toString().trim()!==a.toString().trim()},b.prototype.changed=function(a){return this.el.trigger("echoforms:controlchange",this.el,this,a)},b.prototype.inputSelector=":input",b.prototype.inputs=function(){return null!=this.inputs?this.inputs:this.inputs=this.el.find(this.inputSelector)},b.prototype.relevant=function(a){var b;return null==a?!el.hasClass("echoforms-irrelevant"):(b=!!a,b!==this.relevant()?(el.toggleClass("echoforms-irrelevant",!b),el.toggle(b)):void 0)},b.prototype.readonly=function(a){var b;return null==a?el.hasClass("echoforms-readonly"):(b=!!a,b!==this.readonly()?(el.toggleClass("echoforms-readonly ui-state-disabled",b),this.updateReadonly(b)):void 0)},b.prototype.updateReadonly=function(a){return this.inputs().attr("disabled",a),this.inputs().attr("readonly",a)},b.prototype.value=function(a){return null==a?this.getValue():this.isChanged()?(this.setValue(a),this.changed(a)):void 0},b.prototype.getValue=function(){},b.prototype.setValue=function(){var a=this;return{onChange:function(){return a.changed(a.getValue())}}},b}(),j=function(a){function d(){return t=d.__super__.constructor.apply(this,arguments)}return c(d,a),d.selector=".echoforms-group, .echoforms-repeat",d.prototype.inputs=function(){return b()},d.prototype.getValue=function(){var a;return this.el.data("echoformsRef")?(a=this.el.closest(".echoforms-echoform").data("echoformsInterface"),a.instanceValue(this.el,"echoformsRef")):void 0},d}(g),i=function(a){function b(){return u=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector=".echoforms-control-checkbox",b.prototype.inputSelector=":checkbox",b.prototype.getValue=function(){return this.inputs().is(":checked")},b.prototype.setValue=function(a){return this.inputs().attr("checked",a.toString()===!0)},b}(g),m=function(a){function d(){return v=d.__super__.constructor.apply(this,arguments)}return c(d,a),d.selector=".echoforms-control-output",d.prototype.inputs=function(){return b()},d.prototype.getValue=function(){return this.el.find(".elements > a, .elements p").text()},d.prototype.setValue=function(a){var b;return b=this.el.find(".elements > a, .elements p"),b.is("a")&&b.attr("href",a),b.text(a)},d}(g),k=function(a){function b(){return w=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector=".echoforms-control",b.prototype.getValue=function(){return this.inputs().val()},b.prototype.setValue=function(a){return this.inputs().val(a)},b}(g),f=function(){function a(a){this.attrs=a}return a.prototype.message=function(){return this.attrs.alert},a}(),l=function(){function c(c,d){this.root=c,this._onSubmit=a(this._onSubmit,this),this._onControlChange=a(this._onControlChange,this),this.options=b.extend({},o,d),this.controlClasses=this.options.controls.concat(n),this._defaults=o,this._name=r,this.root=c=b(c),c.data("echoformsInterface",this),c.bind("echoforms:refresh",this.waitThenRefresh),c.submit(this._onSubmit),c.closest("form#form-test").submit(this._onSubmit),this.instance=new h(c.find(".echoforms-model").text()),this.initializeInstance(c)}return c.inputTimeout=null,c.prototype.initializeInstance=function(a){var c,d;return this.refresh(),d=this,c=a.find(".echoforms-control"),c.each(function(){var a,c,e,f,g,h;if(c=b(this),!c.data("echoformsControl")){for(g=d.controlClasses,h=[],e=0,f=g.length;f>e;e++){if(a=g[e],c.is(a.selector)){p(a)?c.data("echoformsControl",new a(c)):c.data("echoformsControl",new Object(a));break}h.push(void 0)}return h}}),c.bind("echoforms:controlchange",this._onControlChange),this.root.trigger("echoforms:instanceInitialized",a)},c.prototype._onControlChange=function(a,b,c,d){var e;return e=this.instanceContext(b),this.instance.update(e,b.data("echoformsRef"),null,d),b.addClass("echoforms-updating"),this.waitThenRefresh()},c.prototype._waitThenRefresh=function(){var a;return clearTimeout(EchoFormInterface.inputTimeout),a="$('.echoform:visible').each(function() {   $(this).data('echoformsUi').refresh();});",EchoFormInterface.inputTimeout=setTimeout(a,500)},c.prototype._onSubmit=function(a){var c,d,e;return this.refresh(),this.root.hasClass("echoforms-invalid")?(d="Please correct errors identified in bold before submitting the form",this.root.find(".echoforms-alert").text(d).show(),a.preventDefault(),!1):(c=new h(this.instance.serialize()),e=this,this.root.find(".echoforms-irrelevant").each(function(){var a;return a=b(this),this.instance.prune(e.instanceContext(a),a.data("echoformsRef"))}),this.root.find(".model").val(this.instance.serialize()),this.instance=c)},c.prototype.refresh=function(){var a;return this.root.trigger("echoforms:beforerefresh",this),a=this,this.root.find(".echoforms-control").each(function(){var c,d,e,f;return d=b(this),c=b(this).data("echoformsControl"),null!=c?(c.value(a.instanceValue(d,"echoformsRef")),f=this.instanceValue(d,"echoformsRelevant",{"default":!0}),c.relevant(f),e=this.instanceValue(d,"echoformsReadonly",{"default":!1}),c.readonly(e)):void 0}),this.root.trigger("echoforms:refresh",this)},c.prototype.validate=function(){return console.log("TODO: Validations")},c.prototype.instanceContext=function(a){var b;return b=a.parentsUntil("echoform","[data-echoforms-ref]").first(),b.length>0?this.instanceXPath(b,"echoformsRef")[0]:this.instance.root},c.prototype.instanceXPath=function(a,b){var c,d;return d=a.data(b),null==d?null:(c=this.instanceContext(a),this.instance.find(c,d))},c.prototype.instanceValue=function(a,b,c){var d;return null==c&&(c={}),d=this.instanceXPath(a,b),d instanceof Array&&(d=d[0].getValues(a.data("echoformsValueElementName"))),null!=d?d:c["default"]},c}(),b.fn[r]=function(a){return this.each(function(){}),b.data(this,"echoformsInterface")?void 0:b.data(this,"echoformsInterface",new l(this,a))},b(e).ready(function(){var a;return a=function(a){return a.replace(/\s+/g," ").replace(/> </g,">\n<")},b(e).bind("echoforms:instanceChange",function(c,d){return b("#debug").text(a(d.serialize()))})})}(jQuery,window,document)}).call(this);