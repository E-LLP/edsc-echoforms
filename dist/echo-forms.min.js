/*
 *  echo-forms.js - v1.0.0
 */
(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b},c=function(a,b){return function(){return a.apply(b,arguments)}};!function(a,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab;return null==(Q=String.prototype).trim&&(Q.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")}),N=function(){return!(!object||"[object Function]"!==getClass.call(object))},O=function(b,c){return a(b).find(c).filter(function(){return!a(this).parentsUntil(b,c).length})},f=function(){function a(a){this.message=a}return a.prototype.check=function(){return console.warn(""+this.constructor.name+" must override check")},a}(),u=function(a){function c(a,b){this.pattern=new RegExp("^"+a+"$"),c.__super__.constructor.call(this,null!=b?b:"Invalid")}return b(c,a),c.prototype.check=function(a){return null!==pattern.exec(a)},c}(f),I=function(a){function c(a,b){this.xpath=a,c.__super__.constructor.call(this,null!=b?b:"Invalid")}return b(c,a),c.prototype.check=function(a,b,c){return b.xpath(this.xpath,c)},c}(f),F=function(a){function c(a,b){var d,e;null==b&&(b=null),e=a.match(/^(?:[^:]+:)?(.*)$/),this.type=e?e[1]:a,d=/^[aeiou]/i.test(this.type)?"an":"a",c.__super__.constructor.call(this,null!=b?b:"Value must be "+d+" "+this.type)}return b(c,a),c.MIN_SHORT=-Math.pow(2,15),c.MAX_SHORT=Math.pow(2,15)-1,c.MIN_INT=-Math.pow(2,31),c.MAX_INT=Math.pow(2,31)-1,c.MIN_LONG=-Math.pow(2,63),c.MAX_LONG=Math.pow(2,63)-1,c.prototype.check=function(a){if(!a)return!0;switch(this.type){case"string":return!0;case"anyuri":return!0;case"double":return this.checkDouble(a);case"long":return this.checkLong(a);case"int":return this.checkInt(a);case"short":return this.checkShort(a);case"datetime":return this.checkDateTime(a);case"boolean":return this.checkBoolean(a);default:return console.warn("Unable to validate type: ",this.type),!0}},c.prototype._checkIntegerRange=function(a,b,c){var d;return d=Number(c),!isNaN(d)&&d>=a&&b>=d&&-1===c.indexOf(".")},c.prototype.checkDouble=function(a){return!isNaN(Number(a))},c.prototype.checkLong=function(a){return this._checkIntegerRange(c.MIN_LONG,c.MAX_LONG,a)},c.prototype.checkInt=function(a){return this._checkIntegerRange(c.MIN_INT,c.MAX_INT,a)},c.prototype.checkShort=function(a){return this._checkIntegerRange(c.MIN_SHORT,c.MAX_SHORT,a)},c.prototype.checkBoolean=function(a){return"true"===a||"false"===a},c.prototype.checkDateTime=function(){return console.warn("Implement datetime validation"),!0},c}(f),A=function(a){function c(a,b){this.xpath=a,null==b&&(b="Required field"),c.__super__.constructor.call(this,b)}return b(c,a),c.prototype.check=function(a,b,c){return!!a||b.xpath(this.xpath,c)},c}(f),q=function(a){function c(a,b){this.count=a,null==b&&(b=null),c.__super__.constructor.call(this,null!=b?b:this.buildMessage())}return b(c,a),c.prototype.itemWord=function(){return 1===this.count?"item":"items"},c}(f),s=function(a){function c(){return R=c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.buildMessage=function(){return"At least "+this.count+" "+this.itemWord()+" required"},c}(q),r=function(a){function c(){return S=c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.buildMessage=function(){return"No more than "+this.count+" "+this.itemWord()+" allowed"},c}(q),M=0,g=function(){function b(b,d,e,f){var g,h,i,j,k;for(this.ui=b,this.model=d,this.controlClasses=e,this.resolver=f,this.onChange=c(this.onChange,this),this.changed=c(this.changed,this),this.refExpr=b.attr("ref"),this.id=null!=(j=b.attr("id"))?j:"echoforms-control-"+M++,this.relevantExpr=b.attr("relevant"),this.requiredExpr=b.attr("required"),this.readonlyExpr=b.attr("readonly"),this.label=b.attr("label"),k=b.children("help"),h=0,i=k.length;i>h;h++)g=k[h],this.help=a(g).text();this.loadConstraints(),this.el=this.buildDom(),this.bindEvents()}return b.prototype.loadConstraints=function(){var b,c,d,e,f,g,h,i,j;for(this.constraints=[],this.requiredExpr&&this.constraints.push(new A(this.requiredExpr)),b=this.ui.children("constraints"),i=b.children("constraint"),j=[],g=0,h=i.length;h>g;g++)d=i[g],d=a(d),c=d.children("alert").text(),e=d.children("pattern"),f=d.children("xpath"),e.length>0&&this.constraints.push(new u(e.text(),c)),f.length>0?j.push(this.constraints.push(new I(f.text(),c))):j.push(void 0);return j},b.prototype.ref=function(){return null!=this.refExpr?this.xpath(this.refExpr):this.model},b.prototype.refValue=function(){return null!=this.refExpr?this.ref().text().trim():""},b.prototype.inputValue=function(){return console.warn(""+this.constructor.name+" must override inputValue")},b.prototype.loadFromModel=function(){return this.validate()},b.prototype.validate=function(){var a,b;return null!=this.relevantExpr&&this.relevant(this.xpath(this.relevantExpr)[0]),null!=this.readonlyExpr&&this.readonly(this.xpath(this.readonlyExpr)[0]),b=function(){var b,c,d,e;for(d=this.constraints,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.check(this.refValue(),this.model,this.resolver)||e.push(a.message);return e}.call(this),b.length>0&&console.log(b),this.setErrors(b)},b.prototype.saveToModel=function(){},b.prototype.bindEvents=function(){},b.prototype.xpath=function(a){return this.model.xpath(a,this.resolver)},b.prototype.element=function(){return null!=this.el?this.el:this.el=this.buildDom()},b.prototype.isChanged=function(){return this.refValue().toString().trim()!==this.inputValue().toString().trim()},b.prototype.changed=function(){return this.el.trigger("echoforms:modelchange")},b.prototype.relevant=function(a){var b;return null==a?!this.el.hasClass("echoforms-irrelevant"):(b=!!a,b!==this.relevant()?(this.el.toggleClass("echoforms-irrelevant",!b),this.el.toggle(b),this.ref().toggleClass("echoforms-pruned",!b)):void 0)},b.prototype.readonly=function(a){var b;return null==a?this.el.hasClass("echoforms-readonly"):(b=!!a,b!==this.readonly()?(this.el.toggleClass("echoforms-readonly ui-state-disabled",b),this.updateReadonly(b)):void 0)},b.prototype.updateReadonly=function(a){return this.inputs().attr("disabled",a),this.inputs().attr("readonly",a)},b.prototype.onChange=function(){return this.isChanged()?(this.saveToModel(),this.changed()):void 0},b.prototype.buildLabelDom=function(){return null!=this.label?a('<label class="echoforms-control-label" for="'+this.id+'-element">'+this.label+"</label>"):a()},b.prototype.buildHelpDom=function(){var b,c,d,e,f;for(c=a(),f=this.ui.children("help"),d=0,e=f.length;e>d;d++)b=f[d],c=c.add('<label class="echoforms-help" for="'+this.id+'-element">'+a(b).text()+"</label>");return c},b.prototype.buildControlDom=function(){return a('<div id="'+this.id+'" class="echoforms-control echoforms-control-'+this.ui[0].nodeName+'"/>')},b.prototype.buildElementsDom=function(){return a('<div class="echoforms-elements"/>').append(this.buildElementsChildrenDom())},b.prototype.buildErrorsDom=function(){return a('<div class="echoforms-errors"/>')},b.prototype.setErrors=function(b){var c,d,e,f,g;for(d=a(),f=0,g=b.length;g>f;f++)e=b[f],c=a('<div class="echoforms-error"/>'),c.text(e),d=d.add(c);return this.el.find(".echoforms-errors").empty().append(d)},b.prototype.buildElementsChildrenDom=function(){return a()},b.prototype.buildDom=function(){var a;return a=this.buildControlDom(),a.append(this.buildLabelDom()),a.append(this.buildElementsDom()),a.append(this.buildHelpDom()),a.append(this.buildErrorsDom()),a},b}(),G=function(a){function c(a,b,d,e){var f;this.inputType=(null!=(f=a.attr("type"))?f:"string").replace(/^.*:/,"").toLowerCase(),c.__super__.constructor.call(this,a,b,d,e)}return b(c,a),c.prototype.loadConstraints=function(){return c.__super__.loadConstraints.call(this),this.constraints.push(new F(this.inputType))},c.prototype.inputs=function(){return null!=this._inputs?this._inputs:this._inputs=this.el.find(":input")},c.prototype.bindEvents=function(){return this.inputs().bind("click change",this.onChange)},c.prototype.inputValue=function(){return this.inputs().val()},c.prototype.saveToModel=function(){return c.__super__.saveToModel.call(this),this.ref().text(this.inputValue())},c.prototype.loadFromModel=function(){return c.__super__.loadFromModel.call(this),this.inputs().val(this.refValue())},c}(g),p=function(c){function d(){return V=d.__super__.constructor.apply(this,arguments)}return b(d,c),d.selector="input",d.prototype.buildElementsChildrenDom=function(){var b;return b=a('<input id="'+this.id+'-element" type="text" class="echoforms-element-input echoforms-element-input-'+this.inputType+'" autocomplete="off">'),"datetime"===this.inputType&&b.attr("placeholder","MM/DD/YYYY HH:MM:SS"),b},d}(G),h=function(a){function c(){return W=c.__super__.constructor.apply(this,arguments)}return b(c,a),c.selector="input[type$=boolean]",c.prototype.inputValue=function(){return this.inputs().is(":checked")},c.prototype.loadFromModel=function(){return c.__super__.loadFromModel.call(this),this.inputs().attr("checked","true"===this.refValue().toString().trim())},c.prototype.buildElementsChildrenDom=function(){return c.__super__.buildElementsChildrenDom.call(this).attr("type","checkbox")},c}(p),t=function(c){function d(a,b,c,e){this.valueExpr=a.attr("value"),d.__super__.constructor.call(this,a,b,c,e)}return b(d,c),d.selector="output",d.prototype.inputs=function(){return a()},d.prototype.loadFromModel=function(){return d.__super__.loadFromModel.call(this),this.el.find(".echoforms-elements > p").text(this.refValue())},d.prototype.buildElementsChildrenDom=function(){return a("<p/>")},d}(G),H=function(c){function d(){return X=d.__super__.constructor.apply(this,arguments)}return b(d,c),d.selector="output[type$=anyURI], output[type$=anyuri]",d.prototype.loadFromModel=function(){var a;return a=this.refValue(),this.el.find(".echoforms-elements > a").text(a).attr("href",a)},d.prototype.buildElementsChildrenDom=function(){return a('<a href="#" />')},d}(t),C=function(c){function d(b,c,e,f){var g,h,i;this.isOpen="true"===b.attr("open"),this.isMultiple="true"===b.attr("multiple"),this.valueElementName=b.attr("valueElementName"),this.items=function(){var c,d,e,f,j;for(e=b.children("item"),j=[],c=0,d=e.length;d>c;c++)g=e[c],f=[a(g).attr("label"),a(g).attr("value")],h=f[0],i=f[1],j.push([null!=h?h:i,i]);return j}(),d.__super__.constructor.call(this,b,c,e,f)}return b(d,c),d.selector="select",d.prototype.buildElementsChildrenDom=function(){var b,c,d,e,f,g,h,i;for(b=a('<select id="'+this.id+'-element" class="echoforms-element-select" autocomplete="off"/>'),this.isMultiple?(b.addClass("echoforms-element-select-multiple"),b.attr("multiple","multiple")):b.append('<option value=""> -- Select a value -- </option>'),this.isOpen&&b.addClass("echoforms-element-select-open"),g=this.items,i=[],e=0,f=g.length;f>e;e++)h=g[e],c=h[0],d=h[1],i.push(b.append('<option value="'+d+'">'+c+"</option>"));return i},d}(G),v=function(a){function c(a,b,d,e){this.start=a.attr("start"),this.end=a.attr("end"),this.step=a.attr("step"),c.__super__.constructor.call(this,a,b,d,e)}return b(c,a),c.selector="range",c}(p),B=function(a){function c(){return Y=c.__super__.constructor.apply(this,arguments)}return b(c,a),c.selector="secret",c.prototype.buildElementsChildrenDom=function(){return c.__super__.buildElementsChildrenDom.call(this).attr("type","password")},c}(p),E=function(c){function d(){return Z=d.__super__.constructor.apply(this,arguments)}return b(d,c),d.selector="textarea",d.prototype.buildElementsChildrenDom=function(){return a('<textarea id="'+this.id+'-element" class="echoforms-element-textarea" autocomplete="off"/>')},d}(G),o=function(c){function d(){return $=d.__super__.constructor.apply(this,arguments)}return b(d,c),d.prototype.inputs=function(){return a()},d.prototype.loadFromModel=function(){var a,b,c,e,f;for(d.__super__.loadFromModel.call(this),e=this.controls,f=[],b=0,c=e.length;c>b;b++)a=e[b],f.push(a.loadFromModel());return f},d.prototype.buildDom=function(){var b,c,e,f,g,h,i,j,k,l,m,n,o,p,q;for(j=d.__super__.buildDom.apply(this,arguments),e=this.ref(),k=this.ui,f=a(),this.controls=h=[],p=k.children(),l=0,n=p.length;n>l;l++)if(c=p[l],"help"!==c.nodeName){for(i=!1,q=this.controlClasses,m=0,o=q.length;o>m;m++)if(b=q[m],a(c).is(b.selector)){g=new b(a(c),e,this.controlClasses,this.resolver),h.push(g),f=f.add(g.el),i=!0;break}i||console.log("No class available for element:",c)}return j.find(".echoforms-elements").replaceWith(a('<div class="echoforms-children"/>').append(f)),j},d}(g),m=function(a){function c(a,b,d,e){a.attr("ref",b.children()[0].nodeName),c.__super__.constructor.call(this,a,b,d,e),this.loadFromModel()}return b(c,a),c.prototype.bindEvents=function(){var a=this;return this.el.on("echoforms:modelchange",".echoforms-control",function(){return console.log("change"),a.loadFromModel()})},c}(o),n=function(a){function c(){return _=c.__super__.constructor.apply(this,arguments)}return b(c,a),c.selector="group",c}(o),y=function(a){function c(){return ab=c.__super__.constructor.apply(this,arguments)}return b(c,a),c}(o),z=function(c){function d(){return T=d.__super__.constructor.apply(this,arguments)}return b(d,c),d.selector="template",d.prototype.buildDom=function(){return a()},d.prototype.loadFromModel=function(){},d}(o),x=function(a){function c(a,b,d,e){this.minItems=a.attr("minItems"),this.minItems&&(this.minItems=parseInt(this.minItems,10)),this.maxItems=a.attr("maxItems"),this.maxItems&&(this.maxItems=parseInt(this.maxItems,10)),c.__super__.constructor.call(this,a,b,d,e)}return b(c,a),c.selector="repeat",c.prototype.loadConstraints=function(){return c.__super__.loadConstraints.call(this),null!=this.minItems&&this.constraints.push(new s(this.minItems)),null!=this.maxItems?this.constraints.push(new r(this.maxItems)):void 0},c}(o),w=function(a){function c(a,b,d,e){this.idref=a.attr("idref"),c.__super__.constructor.call(this,a,b,d,e)}return b(c,a),c}(g),i=function(a){function c(){return U=c.__super__.constructor.apply(this,arguments)}return b(c,a),c.selector="controlref",c}(w),D=function(c){function d(b){var c,d,e;this.isOpen="true"===b.attr("open"),this.isMultiple="true"===b.attr("multiple"),this.valueElementName=b.attr("valueElementName"),this.items=function(){var f,g,h,i,j;for(h=b.children("item"),j=[],f=0,g=h.length;g>f;f++)c=h[f],i=[a(c).attr("label"),a(c).attr("value")],d=i[0],e=i[1],j.push([null!=d?d:e,e]);return j}()}return b(d,c),d.selector="selectref",d}(w),K=[h,p,H,t,C,v,B,E,n,x,z,i,D],P="echoform",L={controls:[]},j=function(){function b(b){this.document=xmlParse(b),this.root=this.document.firstChild,this.root.prefixElements(),a(e).trigger("echoforms:instanceChange",this)}return b.prototype.find=function(a,b){var c;return c=new ExprContext(null!=a?a:this.root),xpathParse(b).evaluate(c).value},b.prototype.update=function(b,c,d,f){var g,h,i,j;for(null!=d&&(d=this.namespace(b,d)),h=c?this.find(b,c):[b],i=0,j=h.length;j>i;i++)g=h[i],g.setValues(f,d);return a(e).trigger("echoforms:instanceChange",this)},b.prototype.namespace=function(a,b){var c;return c=XNode.create(DOM_ELEMENT_NODE,b,null,null),null==c.getNamespacePrefix()&&c.setNamespacePrefix(a.getNamespacePrefix()),c.nodeName},b.prototype.prune=function(a,b){return XNode.removeAll(this.find(a,b))},b.prototype.serialize=function(){return xmlText(this.document)},b}(),J=function(){function a(a){this.resolve=c(this.resolve,this);var b,d,e,f,g,h;for(f={},e=/\sxmlns(?::(\w+))?=\"([^\"]+)\"/g,b=e.exec(a);null!=b;)d=null!=(h=b[1])?h:" default ",g=b[2],f[d]=g,b=e.exec(a);f.xs="http://www.w3.org/2001/XMLSchema",f.echoforms="http://echo.nasa.gov/v9/echoforms",this.namespaces=f}return a.prototype.resolve=function(a){var b;return null==a&&(a=" default "),b=this.namespaces[a],b||(console.log("Bad prefix: "+a+".  Ignoring."),a=" default "),b},a}(),k=function(){function b(b,c){var e,f,g;this.controlClasses=c,this.resolver=new J(b).resolve,e=a(a.parseXML(b)),this.model=f=e.xpath("//echoforms:form/echoforms:model/echoforms:instance",this.resolver),this.ui=g=e.xpath("//echoforms:form/echoforms:ui",this.resolver),d.ui=g,d.model=f,d.resolver=this.resolver,this.control=new m(g,f,this.controlClasses,this.resolver)}return b.uniqueId=0,b.prototype.element=function(){return this.control.element()},b}(),l=function(){function b(b,d){this.root=b,this._onSubmit=c(this._onSubmit,this),this._onControlChange=c(this._onControlChange,this),this.options=a.extend({},L,d),this.controlClasses=this.options.controls.concat(K),this._defaults=L,this._name=P,this.root=b=a(b),this.builder=new k(b.find(".echoforms-xml").text(),this.controlClasses),b.append(this.builder.element())}return b.inputTimeout=null,b.prototype.initializeInstance=function(b){var c,d;return this.refresh(),d=this,c=b.find(".echoforms-control"),c.each(function(){var b,c,e,f,g,h;if(c=a(this),!c.data("echoformsControl")){for(g=d.controlClasses,h=[],e=0,f=g.length;f>e;e++){if(b=g[e],c.is(b.selector)){N(b)?c.data("echoformsControl",new b(c)):c.data("echoformsControl",new Object(b));break}h.push(void 0)}return h}}),c.bind("echoforms:controlchange",this._onControlChange),this.root.trigger("echoforms:instanceInitialized",b)},b.prototype._onControlChange=function(a,b,c,d){var e;return e=this.instanceContext(b),this.instance.update(e,b.data("echoformsRef"),null,d),b.addClass("echoforms-updating"),this.waitThenRefresh()},b.prototype._waitThenRefresh=function(){var a;return clearTimeout(EchoFormInterface.inputTimeout),a="$('.echoform:visible').each(function() {   $(this).data('echoformsUi').refresh();});",EchoFormInterface.inputTimeout=setTimeout(a,500)},b.prototype._onSubmit=function(b){var c,d,e;return this.refresh(),this.root.hasClass("echoforms-invalid")?(d="Please correct errors identified in bold before submitting the form",this.root.find(".echoforms-alert").text(d).show(),b.preventDefault(),!1):(c=new j(this.instance.serialize()),e=this,this.root.find(".echoforms-irrelevant").each(function(){var b;return b=a(this),this.instance.prune(e.instanceContext(b),b.data("echoformsRef"))}),this.root.find(".model").val(this.instance.serialize()),this.instance=c)},b.prototype.refresh=function(){var b;return this.root.trigger("echoforms:beforerefresh",this),b=this,this.root.find(".echoforms-control").each(function(){var c,d,e,f;return d=a(this),c=a(this).data("echoformsControl"),null!=c?(c.value(b.instanceValue(d,"echoformsRef")),f=this.instanceValue(d,"echoformsRelevant",{"default":!0}),c.relevant(f),e=this.instanceValue(d,"echoformsReadonly",{"default":!1}),c.readonly(e)):void 0}),this.root.trigger("echoforms:refresh",this)},b.prototype.validate=function(){return console.log("TODO: Validations")},b.prototype.instanceContext=function(a){var b;return b=a.parentsUntil("echoform","[data-echoforms-ref]").first(),b.length>0?this.instanceXPath(b,"echoformsRef")[0]:this.instance.root},b.prototype.instanceXPath=function(a,b){var c,d;return d=a.data(b),null==d?null:(c=this.instanceContext(a),this.instance.find(c,d))},b.prototype.instanceValue=function(a,b,c){var d;return null==c&&(c={}),d=this.instanceXPath(a,b),d instanceof Array&&(d=d[0].getValues(a.data("echoformsValueElementName"))),null!=d?d:c["default"]},b}(),a.fn[P]=function(b){return this.each(function(){}),a.data(this,"echoformsInterface")?void 0:a.data(this,"echoformsInterface",new l(this,b))},a(e).ready(function(){var b;return b=function(a){return a.replace(/\s+/g," ").replace(/> </g,">\n<")},a(e).bind("echoforms:instanceChange",function(c,d){return a("#debug").text(b(d.serialize()))})})}(jQuery,window,document)}).call(this);