/*
 *  echo-forms.js - v1.0.0
 */
(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};!function(b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q;return null==(D=String.prototype).trim&&(D.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")}),A=function(){return!(!object||"[object Function]"!==getClass.call(object))},B=function(a,c){return b(a).find(c).filter(function(){return!b(this).parentsUntil(a,c).length})},f=function(){function a(a){this.attrs=a}return a.prototype.message=function(){return this.attrs.alert},a}(),z=0,g=function(){function c(b,c,d){this.ui=b,this.model=c,this.controlClasses=d,this.onChange=a(this.onChange,this),this.changed=a(this.changed,this),this.refExpr=b.attr("ref"),this.relevantExpr=b.attr("relevant"),this.requiredExpr=b.attr("required"),this.readonlyExpr=b.attr("readonly"),this.el=this.buildDom(),this.inputs().bind("click change",this.onChange)}return c.prototype.element=function(){return null!=this.el?this.el:this.el=this.buildDom()},c.prototype.isChanged=function(a){return this.getValue().toString().trim()!==a.toString().trim()},c.prototype.changed=function(a){return this.el.trigger("echoforms:controlchange",this.el,this,a)},c.prototype.inputSelector=":input",c.prototype.inputs=function(){return null!=this.inputs?this.inputs:this.inputs=this.el.find(this.inputSelector)},c.prototype.relevant=function(a){var b;return null==a?!el.hasClass("echoforms-irrelevant"):(b=!!a,b!==this.relevant()?(this.el.toggleClass("echoforms-irrelevant",!b),this.el.toggle(b)):void 0)},c.prototype.readonly=function(a){var b;return null==a?this.el.hasClass("echoforms-readonly"):(b=!!a,b!==this.readonly()?(this.el.toggleClass("echoforms-readonly ui-state-disabled",b),this.updateReadonly(b)):void 0)},c.prototype.updateReadonly=function(a){return this.inputs().attr("disabled",a),this.inputs().attr("readonly",a)},c.prototype.value=function(a){return null==a?this.getValue():this.isChanged()?(this.setValue(a),this.changed(a)):void 0},c.prototype.getValue=function(){},c.prototype.setValue=function(){},c.prototype.onChange=function(){return this.changed(this.getValue())},c.prototype.id=function(){return null!=this._id?this._id:this._id=null!=this.ui.attr("id")?this.ui.attr("id"):"echoforms-control-"+z++},c.prototype.buildLabelDom=function(){var a;return a=this.ui.attr("label"),null!=a?b('<label class="echoforms-control-label" for="'+this.id()+'-element">'+a+"</label>"):b()},c.prototype.buildHelpDom=function(){var a,c,d,e,f;for(c=b(),f=this.ui.children("help"),d=0,e=f.length;e>d;d++)a=f[d],c=c.add('<label class="echoforms-help" for="'+this.id()+'-element">'+b(a).text()+"</label>");return c},c.prototype.buildControlDom=function(){return b('<div id="'+this.id()+'" class="echoforms-control echoforms-control-'+this.ui[0].nodeName+'"/>')},c.prototype.buildElementsDom=function(){return b('<div class="echoforms-elements"/>')},c.prototype.buildDom=function(){var a;return a=this.buildControlDom(),a.append(this.buildLabelDom()),a.append(this.buildElementsDom()),a.append(this.buildHelpDom()),a},c}(),k=function(a){function d(){return E=d.__super__.constructor.apply(this,arguments)}return c(d,a),d.prototype.inputs=function(){return b()},d.prototype.getValue=function(){var a;return this.el.data("echoformsRef")?(a=this.el.closest(".echoforms-echoform").data("echoformsInterface"),a.instanceValue(this.el,"echoformsRef")):void 0},d.prototype.buildDom=function(){var a,c,e,f,g,h,i,j,k,l,m,n,o,p,q;for(j=d.__super__.buildDom.apply(this,arguments),i=this.model,k=this.ui,e=b(),this.controls=g=[],p=k.children(),l=0,n=p.length;n>l;l++){for(c=p[l],h=!1,q=this.controlClasses,m=0,o=q.length;o>m;m++)if(a=q[m],b(c).is(a.selector)){f=new a(b(c),i,this.controlClasses),g.push(f),e=e.add(f.el),h=!0;break}h||console.log("No class available for element:",c)}return j.find(".echoforms-elements").replaceWith(b('<div class="echoforms-children"/>').append(e)),j},d}(g),m=function(a){function b(){return F=b.__super__.constructor.apply(this,arguments)}return c(b,a),b}(k),n=function(a){function b(){return J=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="group",b}(k),s=function(a){function b(){return K=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="repeat",b}(k),q=function(a){function d(){return L=d.__super__.constructor.apply(this,arguments)}return c(d,a),d.selector="output",d.prototype.inputs=function(){return b()},d.prototype.getValue=function(){return this.el.find(".elements > a, .elements p").text()},d.prototype.setValue=function(a){var b;return b=this.el.find(".elements > a, .elements p"),b.is("a")&&b.attr("href",a),b.text(a)},d}(g),o=function(a){function b(){return M=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="input",b.prototype.getValue=function(){return this.inputs().val()},b.prototype.setValue=function(a){return this.inputs().val(a)},b.prototype.inputType=function(){return null!=this._inputType?this._inputType:this._inputType=(null!=this.ui.attr("type")?this.ui.attr("type"):"").replace(/^.*:/,"").toLowerCase()},b.prototype.buildElementsDom=function(){var a,c;return c=this.inputType(),a='<input id="'+this.id()+'" type="text" class"echoforms-element-input echoforms-element-input-'+c+'" autocomplete="off">',"datetime"===c&&a.attr("placeholder","MM/DD/YYYY HH:MM:SS"),b.__super__.buildElementsDom.call(this).append(a)},b}(g),j=function(a){function b(){return N=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="input[type=xsd\\:boolean], input[type=xs\\:boolean]",b.prototype.inputSelector=":checkbox",b.prototype.getValue=function(){return this.inputs().is(":checked")},b.prototype.setValue=function(a){return this.inputs().attr("checked",a.toString()===!0)},b.prototype.buildElementsDom=function(){var a;return a=b.__super__.buildElementsDom.call(this),a.children("input").attr("type","checkbox"),a},b}(o),t=function(a){function b(){return O=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="secret",b}(g),w=function(a){function b(){return P=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="textarea",b}(g),u=function(a){function b(){return Q=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="select",b}(g),l=function(a){function b(){return G=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="controlref",b}(g),v=function(a){function b(){return H=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="selectref",b}(g),r=function(a){function b(){return I=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="range",b}(g),x=[n,s,q,t,w,u,v,l,r,j,o],C="echoform",y={controls:[]},h=function(){function a(a){this.document=xmlParse(a),this.root=this.document.firstChild,this.root.prefixElements(),b(e).trigger("echoforms:instanceChange",this)}return a.prototype.find=function(a,b){var c;return c=new ExprContext(null!=a?a:this.root),xpathParse(b).evaluate(c).value},a.prototype.update=function(a,c,d,f){var g,h,i,j;for(null!=d&&(d=this.namespace(a,d)),h=c?this.find(a,c):[a],i=0,j=h.length;j>i;i++)g=h[i],g.setValues(f,d);return b(e).trigger("echoforms:instanceChange",this)},a.prototype.namespace=function(a,b){var c;return c=XNode.create(DOM_ELEMENT_NODE,b,null,null),null==c.getNamespacePrefix()&&c.setNamespacePrefix(a.getNamespacePrefix()),c.nodeName},a.prototype.prune=function(a,b){return XNode.removeAll(this.find(a,b))},a.prototype.serialize=function(){return xmlText(this.document)},a}(),i=function(){function c(c,e){var f,g,h;this.controlClasses=e,this.resolver=a(this.resolver,this),this.loadNamespaces(c),f=b(b.parseXML(c)),this.model=g=f.xpath("//echoforms:form/echoforms:model",this.resolver),this.ui=h=f.xpath("//echoforms:form/echoforms:ui",this.resolver),d.ui=h,this.control=new m(h,g,this.controlClasses)}return c.uniqueId=0,c.prototype.element=function(){return this.control.element()},c.prototype.resolver=function(a){var b;return null==a&&(a=" default "),b=this.namespaces[a],b||(console.log("Bad prefix: "+a+".  Ignoring."),a=" default "),b},c.prototype.loadNamespaces=function(a){var b,c,d,e,f,g;for(e={},d=/\sxmlns(?::(\w+))?=\"([^\"]+)\"/g,b=d.exec(a);null!=b;)c=null!=(g=b[1])?g:" default ",f=b[2],e[c]=f,b=d.exec(a);return e.xs="http://www.w3.org/2001/XMLSchema",e.echoforms="http://echo.nasa.gov/v9/echoforms",this.namespaces=e},c}(),p=function(){function c(c,d){this.root=c,this._onSubmit=a(this._onSubmit,this),this._onControlChange=a(this._onControlChange,this),this.options=b.extend({},y,d),this.controlClasses=this.options.controls.concat(x),this._defaults=y,this._name=C,this.root=c=b(c),c.data("echoformsInterface",this),c.bind("echoforms:refresh",this.waitThenRefresh),c.submit(this._onSubmit),c.closest("form#form-test").submit(this._onSubmit),this.builder=new i(c.find(".echoforms-xml").text(),this.controlClasses),c.append(this.builder.element()),this.instance=new h(c.find(".echoforms-xml").text()),this.initializeInstance(c)}return c.inputTimeout=null,c.prototype.initializeInstance=function(a){var c,d;return this.refresh(),d=this,c=a.find(".echoforms-control"),c.each(function(){var a,c,e,f,g,h;if(c=b(this),!c.data("echoformsControl")){for(g=d.controlClasses,h=[],e=0,f=g.length;f>e;e++){if(a=g[e],c.is(a.selector)){A(a)?c.data("echoformsControl",new a(c)):c.data("echoformsControl",new Object(a));break}h.push(void 0)}return h}}),c.bind("echoforms:controlchange",this._onControlChange),this.root.trigger("echoforms:instanceInitialized",a)},c.prototype._onControlChange=function(a,b,c,d){var e;return e=this.instanceContext(b),this.instance.update(e,b.data("echoformsRef"),null,d),b.addClass("echoforms-updating"),this.waitThenRefresh()},c.prototype._waitThenRefresh=function(){var a;return clearTimeout(EchoFormInterface.inputTimeout),a="$('.echoform:visible').each(function() {   $(this).data('echoformsUi').refresh();});",EchoFormInterface.inputTimeout=setTimeout(a,500)},c.prototype._onSubmit=function(a){var c,d,e;return this.refresh(),this.root.hasClass("echoforms-invalid")?(d="Please correct errors identified in bold before submitting the form",this.root.find(".echoforms-alert").text(d).show(),a.preventDefault(),!1):(c=new h(this.instance.serialize()),e=this,this.root.find(".echoforms-irrelevant").each(function(){var a;return a=b(this),this.instance.prune(e.instanceContext(a),a.data("echoformsRef"))}),this.root.find(".model").val(this.instance.serialize()),this.instance=c)},c.prototype.refresh=function(){var a;return this.root.trigger("echoforms:beforerefresh",this),a=this,this.root.find(".echoforms-control").each(function(){var c,d,e,f;return d=b(this),c=b(this).data("echoformsControl"),null!=c?(c.value(a.instanceValue(d,"echoformsRef")),f=this.instanceValue(d,"echoformsRelevant",{"default":!0}),c.relevant(f),e=this.instanceValue(d,"echoformsReadonly",{"default":!1}),c.readonly(e)):void 0}),this.root.trigger("echoforms:refresh",this)},c.prototype.validate=function(){return console.log("TODO: Validations")},c.prototype.instanceContext=function(a){var b;return b=a.parentsUntil("echoform","[data-echoforms-ref]").first(),b.length>0?this.instanceXPath(b,"echoformsRef")[0]:this.instance.root},c.prototype.instanceXPath=function(a,b){var c,d;return d=a.data(b),null==d?null:(c=this.instanceContext(a),this.instance.find(c,d))},c.prototype.instanceValue=function(a,b,c){var d;return null==c&&(c={}),d=this.instanceXPath(a,b),d instanceof Array&&(d=d[0].getValues(a.data("echoformsValueElementName"))),null!=d?d:c["default"]},c}(),b.fn[C]=function(a){return this.each(function(){}),b.data(this,"echoformsInterface")?void 0:b.data(this,"echoformsInterface",new p(this,a))},b(e).ready(function(){var a;return a=function(a){return a.replace(/\s+/g," ").replace(/> </g,">\n<")},b(e).bind("echoforms:instanceChange",function(c,d){return b("#debug").text(a(d.serialize()))})})}(jQuery,window,document)}).call(this);