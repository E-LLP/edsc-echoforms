/*
 *  echoforms.js - v1.0.0
 */
(function(){var a=[].slice,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a},d=function(a,b){return function(){return a.apply(b,arguments)}};!function(b,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S;for(K=function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],"undefined"!=typeof console&&null!==console?"function"==typeof console.warn?console.warn.apply(console,b):void 0:void 0},G=function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],"undefined"!=typeof console&&null!==console?"function"==typeof console.error?console.error.apply(console,b):void 0:void 0},"undefined"!=typeof wgxpath&&null!==wgxpath&&"function"==typeof wgxpath.install&&wgxpath.install(e),H=function(a,b,c){var d;if("["===(null!=b?b.charAt(0):void 0)&&(b="self::*"+b),"true"===b)return!0;if("false"===b)return!1;switch(d=f.evaluate(b,a[0],c,XPathResult.ANY_TYPE,null),d.resultType){case XPathResult.NUMBER_TYPE:return d.numberValue;case XPathResult.STRING_TYPE:return d.stringValue;case XPathResult.BOOLEAN_TYPE:return d.booleanValue;default:return d.iterateNext()}},I=function(a){var b,c;if(!a||"string"!=typeof a)return null;c=void 0;try{e.DOMParser?c=(new DOMParser).parseFromString(a,"text/xml"):(c=new ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(a))}catch(d){b=d}return c&&c.documentElement&&!c.getElementsByTagName("parsererror").length||G("Invalid XML: "+a),c},A=function(a){var b,c,d,e,f,g,h;for(f={},b=" default ",e=/\sxmlns(?::(\w+))?=\"([^\"]+)\"/g;null!=(c=e.exec(a));)h=c.slice(1,3),d=h[0],g=h[1],f[null!=d?d:b]=g;return function(a){return f[null!=a?a:b]}},g=function(){function a(a){this.message=a}return a.prototype.check=function(){return K(""+this.constructor.name+" must override check")},a}(),p=function(a){function b(a,c){this.pattern=new RegExp("^"+a+"$"),b.__super__.constructor.call(this,null!=c?c:"Invalid")}return c(b,a),b.prototype.check=function(a){return!a||null!==this.pattern.exec(a)},b}(g),z=function(a){function b(a,c){this.xpath=a,b.__super__.constructor.call(this,null!=c?c:"Invalid")}return c(b,a),b.prototype.check=function(a,b,c){return H(b,this.xpath,c)},b}(g),w=function(a){function b(a,c){var d,e,f;null==c&&(c=null),f=a.match(/^(?:[^:]+:)?(.*)$/),this.type=f?f[1]:a,e=function(){switch(this.type){case"double":return"number";case"long":return"integer between -2^63 and 2^63-1";case"int":return"integer between -2,147,483,648 and 2,147,483,647";case"short":return"integer between -32,768 and 32,767";case"datetime":return"date/time with format MM/DD/YYYYTHH:MM:SS";case"boolean":return"true or false";default:return this.type}}.call(this),d=/^[aeiou]/i.test(e)?"an":"a",b.__super__.constructor.call(this,null!=c?c:"Value must be "+d+" "+e)}return c(b,a),b.MIN_SHORT=-Math.pow(2,15),b.MAX_SHORT=Math.pow(2,15)-1,b.MIN_INT=-Math.pow(2,31),b.MAX_INT=Math.pow(2,31)-1,b.MIN_LONG=-Math.pow(2,63),b.MAX_LONG=Math.pow(2,63)-1,b.prototype.check=function(a){if(!a)return!0;switch(this.type){case"string":return!0;case"anyuri":return!0;case"double":return this.checkDouble(a);case"long":return this.checkLong(a);case"int":return this.checkInt(a);case"short":return this.checkShort(a);case"datetime":return this.checkDateTime(a);case"boolean":return this.checkBoolean(a);default:return K("Unable to validate type: ",this.type),!0}},b.prototype._checkIntegerRange=function(a,b,c){var d;return d=Number(c),!isNaN(d)&&d>=a&&b>=d&&-1===c.indexOf(".")},b.prototype.checkDouble=function(a){return!isNaN(Number(a))},b.prototype.checkLong=function(a){return this._checkIntegerRange(b.MIN_LONG,b.MAX_LONG,a)},b.prototype.checkInt=function(a){return this._checkIntegerRange(b.MIN_INT,b.MAX_INT,a)},b.prototype.checkShort=function(a){return this._checkIntegerRange(b.MIN_SHORT,b.MAX_SHORT,a)},b.prototype.checkBoolean=function(a){return"true"===a||"false"===a},b.prototype.checkDateTime=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;return a.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/)?(k=a.split("T"),b=k[0],i=k[1],l=function(){var a,c,d,e;for(d=b.split("-"),e=[],a=0,c=d.length;c>a;a++)h=d[a],e.push(parseInt(h,10));return e}(),j=l[0],f=l[1],c=l[2],m=function(){var a,b,c,d;for(c=i.split(":"),d=[],a=0,b=c.length;b>a;a++)h=c[a],d.push(parseInt(h,10));return d}(),d=m[0],e=m[1],g=m[2],f>=1&&12>=f&&c>=1&&31>=c&&24>d&&60>e&&60>g):!1},b}(g),r=function(a){function b(a,c){this.xpath=a,null==c&&(c="Required field"),b.__super__.constructor.call(this,c)}return c(b,a),b.prototype.check=function(a,b,c){return a instanceof Array&&0===a.length&&(a=null),!!a||!H(b,this.xpath,c)},b}(g),F=0,h=function(){function a(a,c,e,f){var g,h,i,j,k;for(this.ui=a,this.model=c,this.controlClasses=e,this.resolver=f,this.onChange=d(this.onChange,this),this.changed=d(this.changed,this),this.refExpr=a.attr("ref"),this.id=null!=(j=a.attr("id"))?j:"echoforms-control-"+F++,this.relevantExpr=a.attr("relevant"),this.requiredExpr=a.attr("required"),this.readonlyExpr=a.attr("readonly"),this.label=a.attr("label"),k=a.children("help"),h=0,i=k.length;i>h;h++)g=k[h],this.help=b(g).text();this.loadConstraints(),this.el=this.buildDom()}return a.prototype.loadConstraints=function(){var a,c,d,e,f,g,h,i,j;for(this.constraints=[],this.requiredExpr&&this.constraints.push(new r(this.requiredExpr)),a=this.ui.children("constraints"),i=a.children("constraint"),j=[],g=0,h=i.length;h>g;g++)d=i[g],d=b(d),c=d.children("alert").text(),e=d.children("pattern"),f=d.children("xpath"),e.length>0&&this.constraints.push(new p(e.text(),c)),f.length>0?j.push(this.constraints.push(new z(f.text(),c))):j.push(void 0);return j},a.prototype.ref=function(){return null!=this.refExpr?b(this.xpath(this.refExpr)):this.model},a.prototype.refValue=function(){return null!=this.refExpr?b.trim(this.ref().text()):void 0},a.prototype.inputValue=function(){return K(""+this.constructor.name+" must override inputValue")},a.prototype.loadFromModel=function(){return this.validate()},a.prototype.validate=function(){var a,b,c,d;return d=null==this.relevantExpr||!!this.xpath(this.relevantExpr),c=null!=this.readonlyExpr&&!!this.xpath(this.readonlyExpr),null!=this.relevantExpr&&this.relevant(d),null!=this.readonlyExpr&&this.readonly(c),b=function(){var b,c,d,e,f;for(d=this.constraints,f=[],b=0,c=d.length;c>b;b++)a=d[b],a.check(null!=(e=this.refValue())?e:this.inputValue(),this.model,this.resolver)||f.push(a.message);return f}.call(this),this.setErrors(b)},a.prototype.saveToModel=function(){},a.prototype.xpath=function(a){return H(this.model,a,this.resolver)},a.prototype.element=function(){return null!=this.el?this.el:this.el=this.buildDom()},a.prototype.isChanged=function(){return this.refValue()!==this.inputValue()||!this.refExpr},a.prototype.changed=function(){return this.el.trigger("echoforms:modelchange")},a.prototype.relevant=function(a){var b,c;return null==a?!this.el.hasClass("echoforms-irrelevant"):(b=!!a,b!==this.relevant()&&(this.el.toggleClass("echoforms-irrelevant",!b),this.el.toggle(b),c=this.ref(),c.toggleClass("echoforms-pruned",!b),""===c.attr("class"))?c.removeAttr("class"):void 0)},a.prototype.readonly=function(a){var b;return null==a?this.el.hasClass("echoforms-readonly"):(b=!!a,b!==this.readonly()?(this.el.toggleClass("echoforms-readonly ui-state-disabled",b),this.updateReadonly(b)):void 0)},a.prototype.updateReadonly=function(a){return this.inputs().attr("disabled",a),this.inputs().attr("readonly",a)},a.prototype.onChange=function(){return this.isChanged()?(this.saveToModel(),this.changed()):void 0},a.prototype.buildLabelDom=function(){return null!=this.label?b("<label/>",{"class":"echoforms-label","for":""+this.id+"-element"}).text(this.label):b()},a.prototype.buildHelpDom=function(){var a,c,d,e,f;for(c=b("<div/>",{"class":"echoforms-help"}),f=this.ui.children("help"),d=0,e=f.length;e>d;d++)a=f[d],b("<p/>",{"class":"echoforms-help-item"}).text(b(a).text()).appendTo(c);return c},a.prototype.buildControlDom=function(){return b("<div/>",{id:this.id,"class":"echoforms-control echoforms-control-"+this.ui[0].nodeName})},a.prototype.buildElementsDom=function(){return b("<div/>",{"class":"echoforms-elements"})},a.prototype.buildErrorsDom=function(){return b("<div/>",{"class":"echoforms-errors"})},a.prototype.setErrors=function(a){var c,d,e,f,g;for(d=b(),f=0,g=a.length;g>f;f++)e=a[f],c=b('<div class="echoforms-error"/>'),c.text(e),d=d.add(c);return this.el.find(".echoforms-errors").empty().append(d)},a.prototype.buildDom=function(a){return null==a&&(a=null),this.buildControlDom().append(this.buildLabelDom()).append(this.buildElementsDom()).append(this.buildErrorsDom()).append(this.buildHelpDom())},a}(),x=function(a){function d(a,b,c,e){var f;this.inputType=(null!=(f=a.attr("type"))?f:"string").replace(/^.*:/,"").toLowerCase(),d.__super__.constructor.call(this,a,b,c,e),this.inputs().bind("click change",this.onChange)}return c(d,a),d.prototype.loadConstraints=function(){return d.__super__.loadConstraints.call(this),this.constraints.push(new w(this.inputType))},d.prototype.inputs=function(){return null!=this._inputs?this._inputs:this._inputs=this.el.find(":input")},d.prototype.inputValue=function(){return b.trim(this.inputs().val())},d.prototype.inputAttrs=function(){var a,b;return{id:""+this.id+"-element","class":"echoforms-element-"+(null!=(a=null!=(b=this.inputElementType)?b:this.inputClass)?a:this.ui[0].nodeName),autocomplete:"off"}},d.prototype.saveToModel=function(){return d.__super__.saveToModel.call(this),this.refExpr?this.ref().text(this.inputValue()):void 0},d.prototype.loadFromModel=function(){return d.__super__.loadFromModel.call(this),this.refExpr?this.inputs().val(this.refValue()):void 0},d.prototype.buildDom=function(){return d.__super__.buildDom.call(this).addClass("echoforms-typed-control")},d.prototype.buildElementsDom=function(){return d.__super__.buildElementsDom.call(this).append(b("<"+this.inputTag+"/>",this.inputAttrs()))},d}(h),n=function(a){function d(){return N=d.__super__.constructor.apply(this,arguments)}return c(d,a),d.selector="input",d.prototype.inputClass="input",d.prototype.inputTag="input",d.prototype.inputElementType="text",d.prototype.inputAttrs=function(){var a;return a=b.extend(d.__super__.inputAttrs.call(this),{type:this.inputElementType}),"datetime"===this.inputType&&(a.placeholder="MM/DD/YYYYTHH:MM:SS"),a},d}(x),i=function(a){function b(){return O=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="input[type$=boolean]",b.prototype.inputClass="checkbox",b.prototype.inputElementType="checkbox",b.prototype.inputValue=function(){return this.inputs().prop("checked").toString()},b.prototype.loadFromModel=function(){return b.__super__.loadFromModel.call(this),this.refExpr?this.inputs().prop("checked","true"===this.refValue()):void 0},b.prototype.buildDom=function(){var a;return a=b.__super__.buildDom.call(this),a.addClass("echoforms-control-checkbox"),a.children(".echoforms-elements").after(a.children(".echoforms-label")),a},b}(n),o=function(a){function d(a,b,c,e){this.valueExpr=a.attr("value"),d.__super__.constructor.call(this,a,b,c,e)}return c(d,a),d.selector="output",d.prototype.inputTag="p",d.prototype.inputs=function(){return b()},d.prototype.inputAttrs=function(){var a;return a=d.__super__.inputAttrs.call(this),delete a.autocomplete,a},d.prototype.refValue=function(){return this.valueExpr?this.xpath(this.valueExpr):d.__super__.refValue.call(this)},d.prototype.loadFromModel=function(){return d.__super__.loadFromModel.call(this),this.refExpr||this.valueExpr?this.el.find(".echoforms-elements > p").text(this.refValue()):void 0},d}(x),y=function(a){function d(){return P=d.__super__.constructor.apply(this,arguments)}return c(d,a),d.selector="output[type$=anyURI], output[type$=anyuri]",d.prototype.inputTag="a",d.prototype.inputAttrs=function(){return b.extend(d.__super__.inputAttrs.call(this),{href:"#"})},d.prototype.loadFromModel=function(){var a;return a=this.refValue(),this.refExpr||this.valueExpr?this.el.find(".echoforms-elements > a").text(a).attr("href",a):void 0},d}(o),t=function(a){function d(a,c,e,f){var g,h,i;this.isMultiple="true"===a.attr("multiple"),this.valueElementName=a.attr("valueElementName"),this.items=function(){var c,d,e,f,j;for(e=a.children("item"),j=[],c=0,d=e.length;d>c;c++)g=e[c],f=[b(g).attr("label"),b(g).attr("value")],h=f[0],i=f[1],j.push([null!=h?h:i,i]);return j}(),d.__super__.constructor.call(this,a,c,e,f)}return c(d,a),d.selector="select",d.prototype.inputTag="select",d.prototype.refValue=function(){var a,c,e,f,g;if(null!=this.valueElementName&&null!=this.refExpr){for(f=this.ref().children(this.valueElementName),g=[],c=0,e=f.length;e>c;c++)a=f[c],g.push(b(a).text());return g}return d.__super__.refValue.call(this)},d.prototype.saveToModel=function(){var a,c,e,g,h,i,j,k,l,m,n,o;if(null!=this.valueElementName&&null!=this.refExpr){for(h=this.ref().empty(),m=h[0].nodeName.split(":").reverse(),c=m[0],e=m[1],i=this.valueElementName,null!=e&&(i=""+e+":"+i),n=this.inputValue(),o=[],k=0,l=n.length;l>k;k++)j=n[k],a=f.createElementNS(h[0].namespaceURI,i),g=b(a).text(j),h.append(g),o.push(g[0].namespaceURI=h[0].namespaceURI);return o}return d.__super__.saveToModel.call(this)},d.prototype.loadFromModel=function(){var a,c;return null!=this.valueElementName&&null!=this.refExpr?(this.validate(),c=function(){var c,d,e,f;for(e=this.ref().children(),f=[],c=0,d=e.length;d>c;c++)a=e[c],f.push(b(a).text());return f}.call(this),this.isMultiple||(c=c[0]),this.inputs().val(c)):d.__super__.loadFromModel.call(this)},d.prototype.inputValue=function(){var a;return a=this.inputs().val(),null==this.valueElementName||a instanceof Array||(a=null!=a&&""!==a?[a]:[]),a},d.prototype.inputAttrs=function(){return b.extend(d.__super__.inputAttrs.call(this),{multiple:this.isMultiple})},d.prototype.buildElementsDom=function(){var a,c,e,f,g,h,i,j;for(e=d.__super__.buildElementsDom.call(this),a=e.children("select"),this.multiple||a.append('<option value=""> -- Select a value -- </option>'),i=this.items,g=0,h=i.length;h>g;g++)j=i[g],c=j[0],f=j[1],b("<option/>",{value:f}).text(c).appendTo(a);return e},d}(x),q=function(a){function b(a,c,d,e){this.start=a.attr("start"),this.end=a.attr("end"),this.step=a.attr("step"),b.__super__.constructor.call(this,a,c,d,e)}return c(b,a),b.selector="range",b}(n),s=function(a){function b(){return Q=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="secret",b.prototype.inputElementType="password",b}(n),v=function(a){function b(){return R=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="textarea",b.prototype.inputTag="textarea",b}(x),m=function(a){function d(a,b,c,e){a.removeAttr("required"),d.__super__.constructor.call(this,a,b,c,e)}return c(d,a),d.prototype.inputs=function(){return b()},d.prototype.loadFromModel=function(){var a,b,c,e,f;for(d.__super__.loadFromModel.call(this),e=this.controls,f=[],b=0,c=e.length;c>b;b++)a=e[b],f.push(a.loadFromModel());return f},d.prototype.buildLabelDom=function(){return null!=this.label?b("<h1/>",{"class":"echoforms-label"}).text(this.label):b()},d.prototype.buildDom=function(){var a,c,e,f,g,h,i,j,k,l,m,n,o,p;for(i=d.__super__.buildDom.call(this).addClass("echoforms-grouping-control"),i.children(".echoforms-label").after(i.children(".echoforms-help")),e=this.ref(),j=this.ui,f=b(),this.controls=h=[],o=j.children(),k=0,m=o.length;m>k;k++)if(c=o[k],"help"!==c.nodeName&&"constraints"!==c.nodeName)for(p=this.controlClasses,l=0,n=p.length;n>l;l++)if(a=p[l],b(c).is(a.selector)){g=new a(b(c),e,this.controlClasses,this.resolver),h.push(g),f=f.add(g.el);break}return i.find(".echoforms-elements").replaceWith(b('<div class="echoforms-children"/>').append(f)),i},d.prototype.updateReadonly=function(a){var b,c,e,f,g;for(d.__super__.updateReadonly.call(this,a),f=this.controls,g=[],c=0,e=f.length;e>c;c++)b=f[c],g.push(b.updateReadonly(a));return g},d}(h),k=function(a){function d(a,b,c,e){var f=this;d.__super__.constructor.call(this,a,b,c,e),this.el.bind("echoforms:modelchange",function(){return f.loadFromModel()}),this.loadFromModel()}return c(d,a),d.prototype.ref=function(){return this.model.children()},d.prototype.isValid=function(){return 0===this.el.find(".echoforms-error:visible").length},d.prototype.serialize=function(){var a;return a=this.model.children().clone(),a.find(".echoforms-pruned").remove(),b("<div>").append(a).html()},d}(m),l=function(a){function b(){return S=b.__super__.constructor.apply(this,arguments)}return c(b,a),b.selector="group",b}(m),u=function(a){function b(a,c,d,e){var f;f=a.attr("valueElementName"),null==f&&a.attr("valueElementName","value"),b.__super__.constructor.call(this,a,c,d,e)}return c(b,a),b.selector="selectref",b.prototype.buildDom=function(){return b.__super__.buildDom.call(this).addClass("echoforms-control-select")},b}(t),J="echoforms",E={controls:[]},D=[i,n,y,o,t,q,s,v,l,u],j=function(){function a(a,c){var d,e,f,g,h,i;this.root=a,this.options=b.extend({},E,c),this.form=f=this.options.form,this.controlClasses=d=this.options.controls.concat(D),null==f&&error("You must specify a 'form' option when creating "+J+" instances"),this.resolver=h=A(f),this.doc=e=b(I(f)),this.model=g=e.find("form > model > instance"),this.ui=i=e.find("form > ui"),this.control=new k(i,g,d,h),this.root.append(this.control.element())}return a.prototype.destroy=function(){return this.root.removeData(J).empty()},a.prototype.isValid=function(){return this.control.isValid()},a.prototype.serialize=function(){return this.control.serialize()},a}(),C={},L=0,M=D.length;M>L;L++)B=D[L],C[B.name]=B;return b[J]={control:function(a,b){return null==b&&(b={}),D.unshift(a),b["export"]&&(C[a.name]=a),this},controls:C},b.fn[J]=function(){var c,d,e,f;return c=1<=arguments.length?a.call(arguments,0):[],c.length>0&&"string"==typeof c[0]?(f=c,d=f[0],c=2<=f.length?a.call(f,1):[],e=this.map(function(){var e,f,g,h;return f=b.data(this,J),f?/^debug_/.test(d)?(h=d.split("_"),g=h[0],e=2<=h.length?a.call(h,1):[],f[e.join("_")]):/^_/.test(d)||"function"!=typeof(null!=f?f[d]:void 0)?(G("Could not call "+d+" on "+J+" instance:",this),null):f[d].apply(f,c):(K(""+J+" not found on instance"),this)}),e[0]):c.length<2?this.each(function(){var a;return a=c[0],null==b.data(this,J)?b.data(this,J,new j(b(this),a)):void 0}):(G("Bad arguments to "+J+":",c),this)}}(jQuery,window,document)}).call(this);